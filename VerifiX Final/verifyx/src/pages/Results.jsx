import { useState, useEffect } from 'react'
import { useNavigate, Link, useLocation } from 'react-router-dom'
import { signOut, onAuthStateChanged } from 'firebase/auth'
import { auth } from '../firebase/config'
import Logo from '../components/Logo'
import StatusBadge from '../components/StatusBadge'
import RiskLevelBadge from '../components/RiskLevelBadge'
import { getAllReceipts } from '../data/mockAgentResponse'
import { FiArrowLeft, FiSearch, FiFileText, FiAlertTriangle, FiCheckCircle, FiX, FiInfo, FiBarChart2, FiPieChart, FiLogOut } from 'react-icons/fi'
import {
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer,
  Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis,
  Cell, PieChart, Pie
} from 'recharts'

/**
 * Results Page
 * 
 * Theme: Clean White/Light Gray (Smooth UI)
 * Fixes: Correctly maps snake_case backend data to frontend model
 */

const generateAuditReport = (receipt) => {
  const date = new Date().toLocaleDateString();
  const time = new Date().toLocaleTimeString();

  return `
============================================================
           VERIFIX AI - OFFICIAL AUDIT REPORT
============================================================
Generated on: ${date} at ${time}
Audit ID:     ${receipt.id}
Status:       ${receipt.status.toUpperCase()}
------------------------------------------------------------

1. DOCUMENT SUMMARY
-------------------
Vendor:       ${receipt.vendor}
Invoice Date: ${receipt.date}
Total Amount: ${receipt.amount.toLocaleString('en-IN', { style: 'currency', currency: 'INR' })}

2. MATCHING ANALYSIS
--------------------
${receipt.poMatch
      ? `Comparison Source: Purchase Order (PO)
PO Vendor:         ${receipt.poMatch.vendor}
PO Date:           ${receipt.poMatch.date}
Match Confidence:  ${(receipt.matchScore * 100).toFixed(2)}%`
      : `Comparison Source: Statutory Archive (No direct PO match)
Match Confidence:  N/A`}

3. AUDIT FINDINGS & RISK ASSESSMENT
-----------------------------------
Risk Level:   ${receipt.agentAnalysis.riskLevel.toUpperCase()}
Detected Issues:
${receipt.agentAnalysis.reasons.length > 0
      ? receipt.agentAnalysis.reasons.map((r, i) => `  [!] ${i + 1}. ${r}`).join('\n')
      : '  [✓] No critical issues detected.'}

4. AI REASONING & RECOMMENDATION
--------------------------------
Analysis Notes:
${receipt.agentAnalysis.notes}

Recommendation:
${receipt.agentAnalysis.riskLevel === 'high'
      ? '⚠️ CRITICAL: Manual review required. Payment should be withheld until discrepancy is resolved.'
      : receipt.agentAnalysis.riskLevel === 'medium'
        ? 'ℹ️ ADVISORY: Minor discrepancies found. Verify with vendor before proceeding.'
        : '✅ APPROVED: Document is compliant and matches reference data.'}

------------------------------------------------------------
This report was autonomously generated by VerifiX AI Agent.
Verification Hash: SHA256-${receipt.id.split('-').pop()}
============================================================
`;
};

const Results = () => {
  const navigate = useNavigate()
  const location = useLocation()
  const [selectedReceiptId, setSelectedReceiptId] = useState(null)
  const [currentPage, setCurrentPage] = useState(1)
  const [receipts, setReceipts] = useState([])
  const [isDetailsModalOpen, setIsDetailsModalOpen] = useState(false)
  const [modalReceipt, setModalReceipt] = useState(null)
  const [showDashboard, setShowDashboard] = useState(true)
  const [user, setUser] = useState(null)
  const itemsPerPage = 5

  // Auth protection
  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged((user) => {
      if (!user) {
        navigate('/login')
      } else {
        setUser(user)
      }
    })
    return () => unsubscribe()
  }, [navigate])

  // Initialize receipts from navigation state or mock data
  useEffect(() => {
    if (location.state?.auditResult) {
      const result = location.state.auditResult

      // DEBUG: Log the raw result to check structure
      console.log('Backend Result:', result)

      // Map backend response (snake_case) to frontend format (camelCase)
      // Handles both direct object and nested 'extracted_data'
      const extracted = result.extracted_data || result.extractedData || {}

      const mappedReceipt = {
        id: result.id,
        vendor: extracted.vendor || 'Unknown Vendor',
        amount: extracted.total_amount || extracted.totalAmount || 0,
        date: extracted.date || new Date().toISOString().split('T')[0],

        // Map risk level to UI status
        status: ['HIGH', 'CRITICAL'].includes(result.risk_level) ? 'risky' :
          result.risk_level === 'MEDIUM' ? 'warning' : 'safe',

        agentAnalysis: {
          riskLevel: (result.risk_level || 'UNKNOWN').toLowerCase(),
          reasons: result.flags ? result.flags.map(f => f.description || f) : [],
          confidenceScore: result.risk_score ? result.risk_score / 100 : 0.95,
          notes: result.explanation || (result.reasoning || []).join(' ') || 'Analysis completed successfully.',
          evidenceImageUrl: null
        },

        // Add PO Match info if available
        poMatch: result.po_match ? {
          id: result.po_match.id || 'Manual Upload',
          vendor: result.po_match.vendor,
          totalAmount: result.po_match.total_amount || result.po_match.totalAmount,
          date: result.po_match.date
        } : null,

        // Match score from backend
        matchScore: result.match_score || result.matchScore || 0,

        // Raw extracted data for deep view
        rawExtractedData: extracted,
        flags: result.flags || []
      }

      setReceipts([mappedReceipt])
      setSelectedReceiptId(mappedReceipt.id)
    } else {
      // Fallback to mock data for demo/testing
      const mockData = getAllReceipts()
      setReceipts(mockData)
      if (mockData.length > 0) {
        setSelectedReceiptId(mockData[0].id)
      }
    }
  }, [location.state])

  const selectedReceipt = receipts.find(r => r.id === selectedReceiptId) || receipts[0]

  const filteredReceipts = receipts

  // Pagination logic
  const totalPages = Math.ceil(filteredReceipts.length / itemsPerPage)
  const startIndex = (currentPage - 1) * itemsPerPage
  const endIndex = startIndex + itemsPerPage
  const paginatedReceipts = filteredReceipts.slice(startIndex, endIndex)

  const handlePageChange = (page) => {
    setCurrentPage(page)
    window.scrollTo({ top: 0, behavior: 'smooth' })
  }


  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(amount)
  }

  const formatDate = (dateString) => {
    if (!dateString) return 'N/A'
    try {
      return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      })
    } catch (e) {
      return dateString
    }
  }

  // Data for Charts
  const getChartData = () => {
    if (!selectedReceipt) return []
    return [
      { name: 'Invoice', amount: selectedReceipt.amount },
      { name: 'PO Reference', amount: selectedReceipt.poMatch ? selectedReceipt.poMatch.totalAmount : selectedReceipt.amount * 0.9 }
    ]
  }

  const getRadarData = () => {
    if (!selectedReceipt) return []
    return [
      { subject: 'Vendor', A: 100, B: selectedReceipt.poMatch ? (selectedReceipt.matchScore > 0.8 ? 100 : 80) : 100, fullMark: 150 },
      { subject: 'Amount', A: 100, B: selectedReceipt.poMatch ? 90 : 100, fullMark: 150 },
      { subject: 'Date', A: 100, B: 100, fullMark: 150 },
      { subject: 'GST', A: 100, B: selectedReceipt.rawExtractedData.gst_no ? 100 : 0, fullMark: 150 },
      { subject: 'Items', A: 100, B: 95, fullMark: 150 },
    ]
  }

  const COLORS = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444']

  return (
    <div className="min-h-screen bg-gray-50 font-sans">
      {/* Header */}
      <header className="bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm">
        <div className="max-w-7xl mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <Logo />
              <span className="h-6 w-px bg-gray-300"></span>
              <span className="text-gray-500 text-sm font-medium">Audit Results</span>
            </div>

            <nav className="flex items-center gap-6">
              <Link to="/upload" className="text-gray-500 hover:text-indigo-600 font-medium transition-colors flex items-center gap-2">
                <FiArrowLeft className="w-4 h-4" /> Upload New
              </Link>
              <button
                onClick={async () => {
                  try {
                    await signOut(auth)
                    navigate('/login')
                  } catch (err) {
                    console.error('Logout failed:', err)
                  }
                }}
                className="text-gray-500 hover:text-red-600 font-medium transition-colors flex items-center gap-2"
              >
                <FiLogOut className="w-4 h-4" /> Sign Out
              </button>
            </nav>
          </div>
        </div>
      </header>

      {/* Main Content - Split Layout */}
      <main className="max-w-7xl mx-auto px-6 py-8">
        <div className="flex gap-8">

          {/* Left Column - List Controls & Table (65%) */}
          <div className="flex-1 space-y-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <h1 className="text-2xl font-bold text-gray-900">Analyzed Invoices</h1>
                <div className="flex bg-gray-100 p-1 rounded-lg">
                  <button
                    onClick={() => setShowDashboard(true)}
                    className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${showDashboard ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                  >
                    <FiPieChart className="inline mr-1" /> Dashboard
                  </button>
                  <button
                    onClick={() => setShowDashboard(false)}
                    className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${!showDashboard ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                  >
                    <FiBarChart2 className="inline mr-1" /> List View
                  </button>
                </div>
              </div>
            </div>

            {showDashboard && selectedReceipt && (
              <div className="grid grid-cols-2 gap-6 animate-in fade-in slide-in-from-top-4 duration-500">
                {/* Amount Comparison Chart */}
                <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                  <h3 className="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <FiBarChart2 className="text-indigo-500" /> Amount Comparison (INR)
                  </h3>
                  <div className="h-[200px] w-full">
                    <ResponsiveContainer width="100%" height="100%">
                      <BarChart data={getChartData()}>
                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f0f0f0" />
                        <XAxis dataKey="name" fontSize={12} tickLine={false} axisLine={false} />
                        <YAxis fontSize={12} tickLine={false} axisLine={false} tickFormatter={(value) => `₹${value / 1000}k`} />
                        <Tooltip
                          contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}
                          formatter={(value) => [formatCurrency(value), 'Amount']}
                        />
                        <Bar dataKey="amount" radius={[4, 4, 0, 0]}>
                          {getChartData().map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={index === 0 ? '#4f46e5' : '#10b981'} />
                          ))}
                        </Bar>
                      </BarChart>
                    </ResponsiveContainer>
                  </div>
                </div>

                {/* Audit Integrity Radar */}
                <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                  <h3 className="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <FiSearch className="text-indigo-500" /> Compliance Mapping
                  </h3>
                  <div className="h-[200px] w-full">
                    <ResponsiveContainer width="100%" height="100%">
                      <RadarChart cx="50%" cy="50%" outerRadius="80%" data={getRadarData()}>
                        <PolarGrid stroke="#f0f0f0" />
                        <PolarAngleAxis dataKey="subject" fontSize={10} />
                        <Radar
                          name="Audit Score"
                          dataKey="B"
                          stroke="#4f46e5"
                          fill="#4f46e5"
                          fillOpacity={0.6}
                        />
                        <Tooltip />
                      </RadarChart>
                    </ResponsiveContainer>
                  </div>
                </div>
              </div>
            )}

            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <table className="w-full text-left border-collapse">
                <thead>
                  <tr className="bg-gray-50/50 border-b border-gray-100">
                    <th className="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                    <th className="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Vendor</th>
                    <th className="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Amount</th>
                    <th className="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Date</th>
                    <th className="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Action</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {paginatedReceipts.map((receipt) => (
                    <tr
                      key={receipt.id}
                      onClick={() => setSelectedReceiptId(receipt.id)}
                      className={`cursor-pointer transition-colors ${selectedReceiptId === receipt.id ? 'bg-indigo-50/50' : 'hover:bg-gray-50'}`}
                    >
                      <td className="px-6 py-4">
                        <StatusBadge status={receipt.status} />
                      </td>
                      <td className="px-6 py-4">
                        <div className="flex flex-col">
                          <span className="font-medium text-gray-900">{receipt.vendor}</span>
                          <span className="text-xs text-gray-500">{receipt.id}</span>
                        </div>
                      </td>
                      <td className="px-6 py-4 font-medium text-gray-700">
                        {formatCurrency(receipt.amount)}
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-500">
                        {formatDate(receipt.date)}
                      </td>
                      <td className="px-6 py-4">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setModalReceipt(receipt);
                            setIsDetailsModalOpen(true);
                          }}
                          className="text-indigo-600 text-sm font-medium hover:underline focus:outline-none"
                        >
                          View Details
                        </button>
                      </td>
                    </tr>
                  ))}
                  {paginatedReceipts.length === 0 && (
                    <tr>
                      <td colSpan="5" className="px-6 py-12 text-center text-gray-500">
                        No invoices found matching your search.
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>

            {/* Simple Pagination */}
            {totalPages > 1 && (
              <div className="flex justify-between items-center pt-2">
                <button
                  disabled={currentPage === 1}
                  onClick={() => handlePageChange(currentPage - 1)}
                  className="px-4 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-white disabled:opacity-50"
                >
                  Previous
                </button>
                <span className="text-sm text-gray-500">Page {currentPage} of {totalPages}</span>
                <button
                  disabled={currentPage === totalPages}
                  onClick={() => handlePageChange(currentPage + 1)}
                  className="px-4 py-2 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-white disabled:opacity-50"
                >
                  Next
                </button>
              </div>
            )}
          </div>

          {/* Right Column - Audit Details (35%) */}
          <div className="w-[400px] shrink-0">
            {selectedReceipt ? (
              <div className="bg-white rounded-xl shadow-md border border-gray-100 flex flex-col sticky top-24 overflow-hidden">

                {/* Card Header */}
                <div className="p-6 border-b border-gray-100 bg-gray-50/30">
                  <div className="flex justify-between items-start mb-2">
                    <h2 className="text-lg font-bold text-gray-900">Audit Findings</h2>
                    <RiskLevelBadge riskLevel={selectedReceipt.agentAnalysis.riskLevel} />
                  </div>
                  <p className="text-sm text-gray-500">AI Confidence Score: <span className="font-semibold text-gray-900">{(selectedReceipt.agentAnalysis.confidenceScore * 100).toFixed(0)}%</span></p>
                </div>

                {/* Findings Info */}
                <div className="p-6 space-y-6">

                  {/* Comparison Info (Dynamic) */}
                  <div className="bg-blue-50 rounded-lg p-4 border border-blue-100">
                    <h3 className="text-xs font-semibold text-blue-800 uppercase tracking-wider mb-2">Comparison Source</h3>
                    {selectedReceipt.poMatch ? (
                      <div className="flex items-start gap-3">
                        <FiCheckCircle className="w-5 h-5 text-green-500 mt-0.5" />
                        <div>
                          <p className="text-sm font-medium text-gray-900">Matched against PO</p>
                          <p className="text-xs text-gray-600">Vendor: {selectedReceipt.poMatch.vendor}</p>
                          <div className="mt-2 flex items-center gap-2">
                            <div className="flex-1 h-1.5 bg-blue-100 rounded-full overflow-hidden">
                              <div
                                className="h-full bg-blue-600 rounded-full"
                                style={{ width: `${(selectedReceipt.matchScore * 100)}%` }}
                              ></div>
                            </div>
                            <span className="text-[10px] font-bold text-blue-700 whitespace-nowrap">
                              {(selectedReceipt.matchScore * 100).toFixed(0)}% MATCH
                            </span>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <div className="flex items-start gap-3">
                        <FiAlertTriangle className="w-5 h-5 text-orange-500 mt-0.5" />
                        <div>
                          <p className="text-sm font-medium text-gray-900">No PO Found</p>
                          <p className="text-xs text-gray-600">Referenced against generated benchmark.</p>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Flags List */}
                  <div>
                    <h3 className="text-sm font-semibold text-gray-900 mb-3">Detected Issues</h3>
                    {selectedReceipt.agentAnalysis.reasons.length > 0 ? (
                      <ul className="space-y-3">
                        {selectedReceipt.agentAnalysis.reasons.map((reason, idx) => (
                          <li key={idx} className="flex items-start gap-3 text-sm text-gray-700 bg-red-50 p-3 rounded-md border border-red-50">
                            <FiAlertTriangle className="w-4 h-4 text-red-500 shrink-0 mt-0.5" />
                            <span>{reason}</span>
                          </li>
                        ))}
                      </ul>
                    ) : (
                      <div className="text-sm text-green-600 bg-green-50 p-3 rounded-md border border-green-100 flex items-center gap-2">
                        <FiCheckCircle /> No compliance issues found.
                      </div>
                    )}
                  </div>

                  {/* Agent Notes */}
                  <div>
                    <h3 className="text-sm font-semibold text-gray-900 mb-2">Analysis Notes</h3>
                    <p className="text-sm text-gray-600 leading-relaxed bg-gray-50 p-3 rounded-md border border-gray-200">
                      {selectedReceipt.agentAnalysis.notes}
                    </p>
                  </div>
                </div>

                <div className="p-4 border-t border-gray-100 bg-gray-50 text-center">
                  <button
                    onClick={() => {
                      const element = document.createElement("a");
                      const reportText = generateAuditReport(selectedReceipt);
                      const file = new Blob([reportText], { type: 'text/plain' });
                      element.href = URL.createObjectURL(file);
                      element.download = `VerifiX-Audit-${selectedReceipt.id}.txt`;
                      document.body.appendChild(element);
                      element.click();
                      document.body.removeChild(element);
                    }}
                    className="text-indigo-600 text-sm font-medium hover:text-indigo-800"
                  >
                    Download Full Audit Report
                  </button>
                </div>
              </div>
            ) : (
              <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center text-gray-500">
                Select an invoice to view analysis details.
              </div>
            )}
          </div>

        </div>
      </main>

      {/* Details Modal */}
      {isDetailsModalOpen && modalReceipt && (
        <div className="fixed inset-0 z-50 overflow-y-auto bg-gray-900/50 backdrop-blur-sm flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col animate-in fade-in zoom-in duration-300">

            {/* Modal Header */}
            <div className="px-8 py-6 border-b border-gray-100 flex items-center justify-between bg-white sticky top-0 z-10">
              <div>
                <h2 className="text-2xl font-bold text-gray-900">Audit Deep Dive</h2>
                <p className="text-sm text-gray-500">ID: {modalReceipt.id}</p>
              </div>
              <button
                onClick={() => setIsDetailsModalOpen(false)}
                className="p-2 hover:bg-gray-100 rounded-full transition-colors"
              >
                <FiX className="w-6 h-6 text-gray-400" />
              </button>
            </div>

            {/* Modal Body */}
            <div className="flex-1 overflow-y-auto p-8 bg-gray-50/30">
              <div className="grid md:grid-cols-3 gap-8">

                {/* Left: Metadata & Summary */}
                <div className="md:col-span-1 space-y-6">
                  <div className="bg-white p-5 rounded-xl border border-gray-100 shadow-sm">
                    <h3 className="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Core Metadata</h3>
                    <div className="space-y-4">
                      <div>
                        <p className="text-xs text-gray-500">Vendor</p>
                        <p className="font-bold text-gray-900">{modalReceipt.vendor}</p>
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <p className="text-xs text-gray-500">Invoice No</p>
                          <p className="font-semibold text-gray-900">{modalReceipt.rawExtractedData.invoice_no || modalReceipt.rawExtractedData.invoiceNo || 'N/A'}</p>
                        </div>
                        <div>
                          <p className="text-xs text-gray-500">Date</p>
                          <p className="font-semibold text-gray-900">{modalReceipt.date}</p>
                        </div>
                      </div>
                      <div>
                        <p className="text-xs text-gray-500">GST Number</p>
                        <p className="font-mono text-xs font-bold text-indigo-700 bg-indigo-50 px-2 py-1 rounded inline-block">
                          {modalReceipt.rawExtractedData.gst_no || modalReceipt.rawExtractedData.gstNo || 'NOT FOUND'}
                        </p>
                      </div>
                    </div>
                  </div>

                  <div className="bg-white p-5 rounded-xl border border-gray-100 shadow-sm">
                    <h3 className="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Financial Overview</h3>
                    <div className="space-y-3">
                      <div className="flex justify-between items-center text-sm">
                        <span className="text-gray-500">Subtotal</span>
                        <span className="text-gray-900 font-medium">
                          {formatCurrency(modalReceipt.amount - (modalReceipt.rawExtractedData.tax_amount || modalReceipt.rawExtractedData.taxAmount || 0))}
                        </span>
                      </div>
                      <div className="flex justify-between items-center text-sm">
                        <span className="text-gray-500">Tax/GST</span>
                        <span className="text-gray-900 font-medium">{formatCurrency(modalReceipt.rawExtractedData.tax_amount || modalReceipt.rawExtractedData.taxAmount || 0)}</span>
                      </div>
                      <div className="pt-3 border-t border-gray-100 flex justify-between items-center">
                        <span className="text-sm font-bold text-gray-900">Total Amount</span>
                        <span className="text-lg font-black text-indigo-600">{formatCurrency(modalReceipt.amount)}</span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Right: Line Items & Deep Audit Findings */}
                <div className="md:col-span-2 space-y-6">

                  {/* Line Items Table */}
                  <div className="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                    <div className="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                      <h3 className="text-sm font-bold text-gray-900">Extracted Line Items</h3>
                      <span className="text-xs text-gray-500">{(modalReceipt.rawExtractedData.line_items || modalReceipt.rawExtractedData.lineItems || []).length} items found</span>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-left">
                        <thead>
                          <tr className="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase tracking-widest border-b border-gray-100">
                            <th className="px-5 py-2">Description</th>
                            <th className="px-5 py-2 text-center">Qty</th>
                            <th className="px-5 py-2 text-right">Unit Price</th>
                            <th className="px-5 py-2 text-right">Total</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-50">
                          {(modalReceipt.rawExtractedData.line_items || modalReceipt.rawExtractedData.lineItems || []).map((item, idx) => (
                            <tr key={idx} className="text-xs text-gray-700">
                              <td className="px-5 py-3 font-medium">{item.description}</td>
                              <td className="px-5 py-3 text-center">{item.quantity}</td>
                              <td className="px-5 py-3 text-right">{formatCurrency(item.unit_price || item.unitPrice)}</td>
                              <td className="px-5 py-3 text-right font-bold">{formatCurrency(item.total)}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  {/* Structural Anomalies Section */}
                  <div className="bg-white p-5 rounded-xl border border-gray-100 shadow-sm">
                    <h3 className="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
                      <FiInfo className="text-indigo-500" /> AI Document Verification Features
                    </h3>
                    <div className="space-y-4">
                      {modalReceipt.rawExtractedData.anomalies && modalReceipt.rawExtractedData.anomalies.length > 0 ? (
                        <div className="grid grid-cols-1 gap-3">
                          {modalReceipt.rawExtractedData.anomalies.map((anomaly, idx) => (
                            <div key={idx} className="flex gap-3 p-4 rounded-lg bg-orange-50 border border-orange-100 text-sm text-orange-800">
                              <FiAlertTriangle className="w-5 h-5 shrink-0 mt-0.5" />
                              <p>{anomaly}</p>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div className="flex items-center gap-3 p-4 rounded-lg bg-green-50 border border-green-100 text-sm text-green-800">
                          <FiCheckCircle className="w-5 h-5 shrink-0" />
                          <p>AI verified document integrity: No mathematical errors or visual alterations detected.</p>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

              </div>
            </div>

            {/* Modal Footer */}
            <div className="px-8 py-4 bg-gray-50 border-t border-gray-100 flex justify-end">
              <button
                onClick={() => setIsDetailsModalOpen(false)}
                className="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors shadow-sm"
              >
                Close Deep Dive
              </button>
            </div>

          </div>
        </div>
      )}
    </div>
  )
}

export default Results
